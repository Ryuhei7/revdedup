\hypertarget{server_8c}{\section{server.\-c \-File \-Reference}
\label{server_8c}\index{server.\-c@{server.\-c}}
}


\-Implements http server for \-Rev\-Dedup.  


{\ttfamily \#include $<$microhttpd.\-h$>$}\*
{\ttfamily \#include $<$revdedup.\-h$>$}\*
{\ttfamily \#include \char`\"{}index.\-h\char`\"{}}\*
{\ttfamily \#include \char`\"{}image.\-h\char`\"{}}\*
{\ttfamily \#include \char`\"{}compress.\-h\char`\"{}}\*
{\ttfamily \#include \char`\"{}bucket.\-h\char`\"{}}\*
\subsection*{\-Classes}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structRequest}{\-Request}
\end{DoxyCompactItemize}
\subsection*{\-Defines}
\begin{DoxyCompactItemize}
\item 
\hypertarget{server_8c_a66c437767a17ce8659aa4b826e73d481}{\#define {\bfseries \-C\-H}(x)~((char $\ast$)x)}\label{server_8c_a66c437767a17ce8659aa4b826e73d481}

\item 
\hypertarget{server_8c_a40086b1fe0bff68a6d05db34279fae6d}{\#define {\bfseries \-S\-Z\-\_\-\-U}~sizeof(uint64\-\_\-t)}\label{server_8c_a40086b1fe0bff68a6d05db34279fae6d}

\item 
\hypertarget{server_8c_a967c53fdae39f9596074ce0764473277}{\#define {\bfseries \-S\-Z\-\_\-\-S}~sizeof(\hyperlink{structSegment}{\-Segment})}\label{server_8c_a967c53fdae39f9596074ce0764473277}

\end{DoxyCompactItemize}
\subsection*{\-Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{structRequest}{\-Request} $\ast$ \hyperlink{server_8c_ac7989ed7a2d58296aa04d8dd4a3eb435}{build\-Request} (\hyperlink{structRequest}{\-Request} $\ast$req, const void $\ast$data, size\-\_\-t size)
\item 
static ssize\-\_\-t \hyperlink{server_8c_a73f0d99ec18991fd0305ef629d7bc4b5}{read\-Fn} (void $\ast$cls, uint64\-\_\-t pos, char $\ast$buf, size\-\_\-t max)
\item 
static void \hyperlink{server_8c_af9d785e3c170e092b3da647efe0621c3}{free\-Fn} (void $\ast$cls)
\item 
static int \hyperlink{server_8c_a29232f17a66efb3c484b3b17bd91e2b5}{reply\-None} (struct \-M\-H\-D\-\_\-\-Connection $\ast$conn, int code)
\item 
static int \hyperlink{server_8c_a520dbf3e71d4ab6f0f176671efb7fce1}{process\-Send} (void $\ast$cls, struct \-M\-H\-D\-\_\-\-Connection $\ast$conn, const char $\ast$url, const char $\ast$method, const char $\ast$version, const char $\ast$upload\-\_\-data, size\-\_\-t $\ast$upload\-\_\-data\-\_\-size, void $\ast$$\ast$con\-\_\-cls)
\item 
static int \hyperlink{server_8c_a7631e6b545ca9fd41ceae254579d56cc}{process\-Meta} (void $\ast$cls, struct \-M\-H\-D\-\_\-\-Connection $\ast$conn, const char $\ast$url, const char $\ast$method, const char $\ast$version, const char $\ast$upload\-\_\-data, size\-\_\-t $\ast$upload\-\_\-data\-\_\-size, void $\ast$$\ast$con\-\_\-cls)
\item 
static int \hyperlink{server_8c_a7df584dc764ed484de541dddf8636ec8}{process\-Data} (void $\ast$cls, struct \-M\-H\-D\-\_\-\-Connection $\ast$conn, const char $\ast$url, const char $\ast$method, const char $\ast$version, const char $\ast$upload\-\_\-data, size\-\_\-t $\ast$upload\-\_\-data\-\_\-size, void $\ast$$\ast$con\-\_\-cls)
\item 
void $\ast$ \hyperlink{server_8c_a4d3ba72f3a995ec5ff2dcb9c255507b6}{end} (void $\ast$ptr)
\item 
void \hyperlink{server_8c_a6b38722bb47fc93ce0ae3c462e6c4934}{sighandler} (int signal)
\item 
int \hyperlink{server_8c_a840291bc02cba5474a4cb46a9b9566fe}{main} (void)
\end{DoxyCompactItemize}
\subsection*{\-Variables}
\begin{DoxyCompactItemize}
\item 
\hypertarget{server_8c_a7b468d6945d9e7fe97fcc4b2e8f3bb6e}{\hyperlink{structIMEntry}{\-I\-M\-Entry} $\ast$ {\bfseries ien}}\label{server_8c_a7b468d6945d9e7fe97fcc4b2e8f3bb6e}

\item 
\hypertarget{server_8c_a78772824a98017982d37b4a6977b5fe7}{\hyperlink{structQueue}{\-Queue} $\ast$ {\bfseries mmq}}\label{server_8c_a78772824a98017982d37b4a6977b5fe7}

\item 
\hypertarget{server_8c_afc774374079106430809733156e70506}{\hyperlink{structQueue}{\-Queue} $\ast$ {\bfseries miq}}\label{server_8c_afc774374079106430809733156e70506}

\item 
\hypertarget{server_8c_aa115d9613fca22401c30bcc843ab011a}{\hyperlink{structQueue}{\-Queue} $\ast$ {\bfseries imq}}\label{server_8c_aa115d9613fca22401c30bcc843ab011a}

\item 
\hypertarget{server_8c_a2a77409927c2558e03e93fbbc899d3d6}{\hyperlink{structQueue}{\-Queue} $\ast$ {\bfseries dcq}}\label{server_8c_a2a77409927c2558e03e93fbbc899d3d6}

\item 
\hypertarget{server_8c_ad2f1aff507b9950351a0455003b9e913}{\hyperlink{structQueue}{\-Queue} $\ast$ {\bfseries bdq}}\label{server_8c_ad2f1aff507b9950351a0455003b9e913}

\end{DoxyCompactItemize}


\subsection{\-Detailed \-Description}
\-Implements http server for \-Rev\-Dedup. \begin{DoxyAuthor}{\-Author}
\-Ng \-Chun \-Ho 
\end{DoxyAuthor}


\subsection{\-Function \-Documentation}
\hypertarget{server_8c_ac7989ed7a2d58296aa04d8dd4a3eb435}{\index{server.\-c@{server.\-c}!build\-Request@{build\-Request}}
\index{build\-Request@{build\-Request}!server.c@{server.\-c}}
\subsubsection[{build\-Request}]{\setlength{\rightskip}{0pt plus 5cm}{\bf \-Request}$\ast$ {\bf build\-Request} (
\begin{DoxyParamCaption}
\item[{{\bf \-Request} $\ast$}]{req, }
\item[{const void $\ast$}]{data, }
\item[{size\-\_\-t}]{size}
\end{DoxyParamCaption}
)}}\label{server_8c_ac7989ed7a2d58296aa04d8dd4a3eb435}
\-Gathers \-H\-T\-T\-P \hyperlink{structRequest}{\-Request} \-Data 
\begin{DoxyParams}{\-Parameters}
{\em req} & \hyperlink{structRequest}{\-Request} \\
\hline
{\em data} & \-Pointer to data \\
\hline
{\em size} & \-Data size \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\hyperlink{structRequest}{\-Request} 
\end{DoxyReturn}
\hypertarget{server_8c_a4d3ba72f3a995ec5ff2dcb9c255507b6}{\index{server.\-c@{server.\-c}!end@{end}}
\index{end@{end}!server.c@{server.\-c}}
\subsubsection[{end}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ {\bf end} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{ptr}
\end{DoxyParamCaption}
)}}\label{server_8c_a4d3ba72f3a995ec5ff2dcb9c255507b6}
\-Routine to destroy segment after it is fully processed 
\begin{DoxyParams}{\-Parameters}
{\em ptr} & useless \\
\hline
\end{DoxyParams}
\hypertarget{server_8c_af9d785e3c170e092b3da647efe0621c3}{\index{server.\-c@{server.\-c}!free\-Fn@{free\-Fn}}
\index{free\-Fn@{free\-Fn}!server.c@{server.\-c}}
\subsubsection[{free\-Fn}]{\setlength{\rightskip}{0pt plus 5cm}static void {\bf free\-Fn} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{cls}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{server_8c_af9d785e3c170e092b3da647efe0621c3}
\-Implements free function after read in microhttpd 
\begin{DoxyParams}{\-Parameters}
{\em cls} & \-Custom argument \\
\hline
\end{DoxyParams}
\hypertarget{server_8c_a840291bc02cba5474a4cb46a9b9566fe}{\index{server.\-c@{server.\-c}!main@{main}}
\index{main@{main}!server.c@{server.\-c}}
\subsubsection[{main}]{\setlength{\rightskip}{0pt plus 5cm}int {\bf main} (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{server_8c_a840291bc02cba5474a4cb46a9b9566fe}
\-Start servers at 3 ports \hypertarget{server_8c_a7df584dc764ed484de541dddf8636ec8}{\index{server.\-c@{server.\-c}!process\-Data@{process\-Data}}
\index{process\-Data@{process\-Data}!server.c@{server.\-c}}
\subsubsection[{process\-Data}]{\setlength{\rightskip}{0pt plus 5cm}static int {\bf process\-Data} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{cls, }
\item[{struct \-M\-H\-D\-\_\-\-Connection $\ast$}]{conn, }
\item[{const char $\ast$}]{url, }
\item[{const char $\ast$}]{method, }
\item[{const char $\ast$}]{version, }
\item[{const char $\ast$}]{upload\-\_\-data, }
\item[{size\-\_\-t $\ast$}]{upload\-\_\-data\-\_\-size, }
\item[{void $\ast$$\ast$}]{con\-\_\-cls}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{server_8c_a7df584dc764ed484de541dddf8636ec8}
\-Routine for processing upload data through \-H\-T\-T\-P \-It will be called multiple times when the request has a body. \-Copy the body to temporary location, and save its pointer to con\-\_\-cls 
\begin{DoxyParams}{\-Parameters}
{\em cls} & \-Custom argument \\
\hline
{\em conn} & \-H\-T\-T\-P \-Connection \\
\hline
{\em url} & \-H\-T\-T\-P request \-U\-R\-L \\
\hline
{\em method} & \-H\-T\-T\-P request method \\
\hline
{\em version} & \-H\-T\-T\-P request version \\
\hline
{\em upload\-\_\-data} & \-H\-T\-T\-P request body (partial) \\
\hline
{\em upload\-\_\-data\-\_\-size} & \-H\-T\-T\-P request body size (partial) \\
\hline
{\em con\-\_\-cls} & \-Pointer for holding temporary data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\-M\-H\-D\-\_\-\-Y\-E\-S for microhttpd 
\end{DoxyReturn}
\hypertarget{server_8c_a7631e6b545ca9fd41ceae254579d56cc}{\index{server.\-c@{server.\-c}!process\-Meta@{process\-Meta}}
\index{process\-Meta@{process\-Meta}!server.c@{server.\-c}}
\subsubsection[{process\-Meta}]{\setlength{\rightskip}{0pt plus 5cm}static int {\bf process\-Meta} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{cls, }
\item[{struct \-M\-H\-D\-\_\-\-Connection $\ast$}]{conn, }
\item[{const char $\ast$}]{url, }
\item[{const char $\ast$}]{method, }
\item[{const char $\ast$}]{version, }
\item[{const char $\ast$}]{upload\-\_\-data, }
\item[{size\-\_\-t $\ast$}]{upload\-\_\-data\-\_\-size, }
\item[{void $\ast$$\ast$}]{con\-\_\-cls}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{server_8c_a7631e6b545ca9fd41ceae254579d56cc}
\-Routine for processing upload metadata through \-H\-T\-T\-P \-It will be called multiple times when the request has a body. \-Copy the body to temporary location, and save its pointer to con\-\_\-cls 
\begin{DoxyParams}{\-Parameters}
{\em cls} & \-Custom argument \\
\hline
{\em conn} & \-H\-T\-T\-P \-Connection \\
\hline
{\em url} & \-H\-T\-T\-P request \-U\-R\-L \\
\hline
{\em method} & \-H\-T\-T\-P request method \\
\hline
{\em version} & \-H\-T\-T\-P request version \\
\hline
{\em upload\-\_\-data} & \-H\-T\-T\-P request body (partial) \\
\hline
{\em upload\-\_\-data\-\_\-size} & \-H\-T\-T\-P request body size (partial) \\
\hline
{\em con\-\_\-cls} & \-Pointer for holding temporary data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\-M\-H\-D\-\_\-\-Y\-E\-S for microhttpd 
\end{DoxyReturn}
\-Construct response \hypertarget{server_8c_a520dbf3e71d4ab6f0f176671efb7fce1}{\index{server.\-c@{server.\-c}!process\-Send@{process\-Send}}
\index{process\-Send@{process\-Send}!server.c@{server.\-c}}
\subsubsection[{process\-Send}]{\setlength{\rightskip}{0pt plus 5cm}static int {\bf process\-Send} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{cls, }
\item[{struct \-M\-H\-D\-\_\-\-Connection $\ast$}]{conn, }
\item[{const char $\ast$}]{url, }
\item[{const char $\ast$}]{method, }
\item[{const char $\ast$}]{version, }
\item[{const char $\ast$}]{upload\-\_\-data, }
\item[{size\-\_\-t $\ast$}]{upload\-\_\-data\-\_\-size, }
\item[{void $\ast$$\ast$}]{con\-\_\-cls}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{server_8c_a520dbf3e71d4ab6f0f176671efb7fce1}
\-Routine for sending out data through \-H\-T\-T\-P. \-It will be called multiple times when the request has a body. \-Copy the body to temporary location, and save its pointer to con\-\_\-cls 
\begin{DoxyParams}{\-Parameters}
{\em cls} & \-Custom argument \\
\hline
{\em conn} & \-H\-T\-T\-P \-Connection \\
\hline
{\em url} & \-H\-T\-T\-P request \-U\-R\-L \\
\hline
{\em method} & \-H\-T\-T\-P request method \\
\hline
{\em version} & \-H\-T\-T\-P request version \\
\hline
{\em upload\-\_\-data} & \-H\-T\-T\-P request body (partial) \\
\hline
{\em upload\-\_\-data\-\_\-size} & \-H\-T\-T\-P request body size (partial) \\
\hline
{\em con\-\_\-cls} & \-Pointer for holding temporary data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\-M\-H\-D\-\_\-\-Y\-E\-S for microhttpd 
\end{DoxyReturn}
\hypertarget{server_8c_a73f0d99ec18991fd0305ef629d7bc4b5}{\index{server.\-c@{server.\-c}!read\-Fn@{read\-Fn}}
\index{read\-Fn@{read\-Fn}!server.c@{server.\-c}}
\subsubsection[{read\-Fn}]{\setlength{\rightskip}{0pt plus 5cm}static ssize\-\_\-t {\bf read\-Fn} (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{cls, }
\item[{uint64\-\_\-t}]{pos, }
\item[{char $\ast$}]{buf, }
\item[{size\-\_\-t}]{max}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{server_8c_a73f0d99ec18991fd0305ef629d7bc4b5}
\-Implements read function for sending out data in microhttpd 
\begin{DoxyParams}{\-Parameters}
{\em cls} & \-Custom argument \\
\hline
{\em pos} & \-Position to read \\
\hline
{\em buf} & \-Buffer to fill \\
\hline
{\em max} & \-Bytes to read \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}

\end{DoxyReturn}
\hypertarget{server_8c_a29232f17a66efb3c484b3b17bd91e2b5}{\index{server.\-c@{server.\-c}!reply\-None@{reply\-None}}
\index{reply\-None@{reply\-None}!server.c@{server.\-c}}
\subsubsection[{reply\-None}]{\setlength{\rightskip}{0pt plus 5cm}static int {\bf reply\-None} (
\begin{DoxyParamCaption}
\item[{struct \-M\-H\-D\-\_\-\-Connection $\ast$}]{conn, }
\item[{int}]{code}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}\label{server_8c_a29232f17a66efb3c484b3b17bd91e2b5}
\-Reply client with no \-H\-T\-T\-P \-Response \-Body 
\begin{DoxyParams}{\-Parameters}
{\em conn} & \-H\-T\-T\-P \-Connection \\
\hline
{\em code} & \-H\-T\-T\-P status code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\-M\-H\-D\-\_\-\-Y\-E\-S for microhttpd 
\end{DoxyReturn}
\hypertarget{server_8c_a6b38722bb47fc93ce0ae3c462e6c4934}{\index{server.\-c@{server.\-c}!sighandler@{sighandler}}
\index{sighandler@{sighandler}!server.c@{server.\-c}}
\subsubsection[{sighandler}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf sighandler} (
\begin{DoxyParamCaption}
\item[{int}]{signal}
\end{DoxyParamCaption}
)}}\label{server_8c_a6b38722bb47fc93ce0ae3c462e6c4934}
\-Used to catch \-S\-I\-G\-I\-N\-T 